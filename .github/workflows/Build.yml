name: Build

on: workflow_call

jobs:
    build:
        runs-on: ${{ matrix.os }}

        strategy:
            fail-fast: false
            matrix:
                os: [macos-latest, ubuntu-latest, windows-latest]

        defaults:
            run:
                shell: pwsh

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  submodules: true

            - uses: ilammy/msvc-dev-cmd@v1 # TODO: is this needed? Linked to the NMake Makefiles if
              if: ${{ matrix.os }} == 'windows-latest'

            - name: Build Lane and Object Detection
              run: |
                  Import-Module ./modules/Build.psd1
                  Build-CppCodeUsingCMake -Platform ${{ matrix.os }} -BuildType Release -BuildDirectory build -Parallel 8 -Verbose

            - name: Get DLLs
              shell: bash
              if: (success() || failure())
              run: |
                  echo "-----------REPO DLL"-----------"
                  find . -name "*.dll"
                  echo "-----------REPO LIB"-----------"
                  find . -name "*.lib"
                  echo "-----------USER DLL"-----------"
                  find /usr/ -name "*.dll"
                  echo "-----------USER LIB"-----------"
                  find /usr/ -name "*.lib"
                  echo "-----------BIN DLL"-----------"
                  find /bin/ -name "*.dll"
                  echo "-----------BIN LIB"-----------"
                  find /bin/ -name "*.lib"
                  echo "-----------HOME DLL"-----------"
                  find /home/ -name "*.dll"
                  echo "-----------HOME LIB"-----------"
                  find /home/ -name "*.lib"
                  echo "-----------OPT DLL"-----------"
                  find /opt/ -name "*.dll"
                  echo "-----------OPT LIB"-----------"
                  find /opt/ -name "*.lib"

            - name: Upload executable as artifact
              uses: actions/upload-artifact@v4
              with:
                  name: lane-and-object-detection-${{ matrix.os }}
                  path: ./build/lane-and-object-detection/
                  if-no-files-found: error
